x-logging: &default-logging
  driver: 'json-file'
  options:
    max-size: "50m"
    max-file: 6

x-base: &base
  profiles: [app]
  build:
    context: .
    dockerfile: Swoole.Dockerfile
    args:
      APP_ENV: 'production'
      APP_HOST: '${APP_HOST}'
      WWWUSER: ${HOST_UID:-1000}
      WWWGROUP: ${HOST_GID:-1000}
  image: laravelx/app
  user: "${HOST_UID:-1000}:${HOST_GID:-1000}"
  ulimits:
    nofile:
      soft: 20000
      hard: 40000
  security_opt:
    - no-new-privileges:true
  volumes:
    - 'db:/var/www/html/db'
  ports:
    - '8000:8000'
  networks:
    - dokploy-network

  labels:
    # Base configuration
    - "traefik.enable=true"
    - "traefik.http.routers.app.rule=Host(`bastardo.761073128.xyz`)"
    - "traefik.http.services.app.loadbalancer.server.port=8000"

    # Compression middleware
    - "traefik.http.middlewares.compress.compress=true"

    # Static assets caching middleware (for JS, CSS, images, fonts)
    - "traefik.http.middlewares.static-assets-cache.headers.customResponseHeaders.Cache-Control=public, max-age=31536000, immutable"
    - "traefik.http.middlewares.html-cache.headers.customResponseHeaders.Cache-Control=public, max-age=3600"

    # Router for static assets (JS, CSS, images, fonts)
    - "traefik.http.routers.static-assets.rule=Host(`bastardo.761073128.xyz`) && PathPathPrefix(`/js/`, `/css/`, `/images/`, `/fonts/`, `/assets/`)"
    - "traefik.http.routers.static-assets.service=app"
    - "traefik.http.routers.static-assets.middlewares=compress,static-assets-cache"

    # Router for HTML and other content
    - "traefik.http.routers.app.middlewares=compress,html-cache"

  logging: *default-logging
  restart: always

services:
  app:
    <<: *base
    healthcheck:
      test: [ "CMD", "curl", "--fail", "localhost:8000/up" ]
      interval: 3s
      retries: 12
      timeout: 5s

networks:
  dokploy-network:
    external: true


volumes:
  db:
    driver: local
